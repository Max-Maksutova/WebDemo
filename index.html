<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Government Reports Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-landmark"></i> Government Reports Dashboard</h1>
      <button class="chat-button"><i class="fas fa-comment-dots"></i> Chat with AI</button>
    </header>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Search reports by title, summary or keywords...">
      
      <div class="select-wrapper">
        <label for="agencyFilter">Agency</label>
        <select id="agencyFilter" multiple></select>
      </div>
      
      <div class="select-wrapper">
        <label for="topicFilter">Topic</label>
        <select id="topicFilter" multiple></select>
      </div>
      
      <div class="select-wrapper">
        <label for="yearFilter">Year</label>
        <select id="yearFilter"></select>
      </div>
      
      <button class="clear-button" onclick="clearAllFilters()">
        <i class="fas fa-times-circle"></i> Clear Filters
      </button>
      
      <button class="export-button" onclick="exportFilteredCSV()">
        <i class="fas fa-file-download"></i> Export CSV
      </button>
    </div>

    <div class="result-summary">
      <span id="resultCount">0</span> reports found
    </div>

    <div class="tags" id="tagContainer"></div>
    
    <div id="reportList"></div>
    
    <div id="pagination">
      <button id="prevPage" class="page-button" disabled><i class="fas fa-chevron-left"></i> Previous</button>
      <div id="pageIndicator">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
      <button id="nextPage" class="page-button"><i class="fas fa-chevron-right"></i> Next</button>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 Government Reports Dashboard. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // Keep track of pagination state
    let currentPage = 1;
    const itemsPerPage = 9;
    
    async function loadCSVasDataFrame(url, reportType) {
      try {
        const res = await fetch(url);
        const text = await res.text();
        const parsed = Papa.parse(text, { 
          header: true, 
          skipEmptyLines: true,
          dynamicTyping: true
        });
        
        return parsed.data.map(row => {
          if (reportType) row.reportType = reportType;
          return row;
        });
      } catch (error) {
        console.error(`Error loading data from ${url}:`, error);
        return [];
      }
    }

    function extractUnique(df, key, splitter = null) {
      const all = df.flatMap(row => {
        const value = row[key] || "";
        return splitter ? value.split(splitter).map(v => v.trim()) : [value.trim()];
      });
      return [...new Set(all.filter(Boolean))].sort();
    }

    function renderMultiselect(id, values) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      const anyOption = document.createElement("option");
      anyOption.value = "__any__";
      anyOption.textContent = "Any";
      select.appendChild(anyOption);
      
      values.forEach(v => {
        const option = document.createElement("option");
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
      });
    }

    let reportData = [];
    let filteredReports = [];

    function getSelectedValues(select) {
      const selected = [...select.selectedOptions].map(opt => opt.value);
      return selected.includes("__any__") ? [] : selected;
    }

    function filterReports() {
      const searchVal = document.getElementById("searchInput").value.toLowerCase();
      const selectedAgencies = getSelectedValues(document.getElementById("agencyFilter"));
      const selectedTopics = getSelectedValues(document.getElementById("topicFilter"));
      const year = document.getElementById("yearFilter").value;
      const activeTags = [...document.querySelectorAll(".tag.active")].map(t => t.textContent);

      filteredReports = reportData.filter(row => {
        const matchesSearch = !searchVal || 
          (row.title && row.title.toLowerCase().includes(searchVal)) || 
          (row.summary && row.summary.toLowerCase().includes(searchVal));
          
        const matchesType = activeTags.length === 0 || activeTags.includes(row.reportType);
        
        const matchesAgency = row.reportType !== "CRS" 
          ? (selectedAgencies.length === 0 || selectedAgencies.includes(row.agency)) 
          : true;

        const matchesCRSTopic = row.reportType === "CRS"
          ? (selectedTopics.length === 0 || (row.topics && row.topics.some(t => selectedTopics.includes(t))))
          : true;

        const matchesFinRelevance = row.reportType !== "CRS"
          ? (selectedTopics.length === 0 || selectedTopics.some(topic => {
              const lowerTopic = topic.toLowerCase();
              return (row.title && row.title.toLowerCase().includes(lowerTopic)) || 
                     (row.agency && row.agency.toLowerCase().includes(lowerTopic));
            }))
          : true;

        const matchesYear = !year || year === "__any__" || 
          (row.date && row.date.startsWith(year));

        return matchesSearch && matchesType && matchesAgency && 
               matchesCRSTopic && matchesFinRelevance && matchesYear;
      });

      // Update UI with filter results
      document.getElementById("resultCount").textContent = filteredReports.length;
      
      // Reset pagination to first page
      currentPage = 1;
      updatePagination();
      renderCurrentPage();
    }

    function updatePagination() {
      const totalPages = Math.max(1, Math.ceil(filteredReports.length / itemsPerPage));
      document.getElementById("currentPage").textContent = currentPage;
      document.getElementById("totalPages").textContent = totalPages;
      
      // Update button states
      document.getElementById("prevPage").disabled = currentPage <= 1;
      document.getElementById("nextPage").disabled = currentPage >= totalPages;
    }

    function renderCurrentPage() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentPageData = filteredReports.slice(startIndex, endIndex);
      
      const container = document.getElementById("reportList");
      container.innerHTML = "";

      if (currentPageData.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-search fa-3x"></i>
            <h3>No matching reports found</h3>
            <p>Try adjusting your filters or search terms</p>
          </div>
        `;
        return;
      }

      currentPageData.forEach(row => {
        const card = document.createElement("div");
        card.className = "report-card";
        
        const reportTypeClass = row.reportType.toLowerCase().replace(/\s+/g, '-');
        const badge = `<div class="badge ${reportTypeClass}">${row.reportType}</div>`;
        
        const pdfLink = row.pdf_url 
          ? `<a href="${row.pdf_url}" target="_blank" class="btn"><i class="fas fa-file-pdf"></i> PDF Report</a>` 
          : "";
          
        const webLink = row.web_url 
          ? `<a href="${row.web_url}" target="_blank" class="btn"><i class="fas fa-globe"></i> Web Page</a>` 
          : "";
          
        const links = pdfLink || webLink 
          ? `<div class="card-actions">${pdfLink} ${webLink}</div>` 
          : "";
          
        const date = row.date 
          ? `<p class="date"><i class="far fa-calendar-alt"></i> ${row.date}</p>` 
          : "";
          
        const topicOrAgency = row.reportType === "CRS" 
          ? (row.topics && row.topics.length ? `<p><strong><i class="fas fa-tag"></i> ${row.topics.join(", ")}</strong></p>` : "")
          : (row.agency ? `<p><strong><i class="fas fa-building"></i> ${row.agency}</strong></p>` : "");
        
        card.innerHTML = `
          ${badge}
          <h3>${row.title || "Untitled Report"}</h3>
          <p class="summary">${row.summary || "No summary available."}</p>
          ${topicOrAgency}
          ${date}
          ${links}
        `;
        
        const summaryEl = card.querySelector(".summary");
        if (summaryEl && row.summary) {
          summaryEl.addEventListener("click", () => summaryEl.classList.toggle("expanded"));
        }
        
        container.appendChild(card);
      });
    }

    function renderTags(types) {
      const tagContainer = document.getElementById("tagContainer");
      tagContainer.innerHTML = "";
      
      const allTag = document.createElement("span");
      allTag.className = "tag active";
      allTag.textContent = "All";
      allTag.onclick = () => {
        document.querySelectorAll(".tag").forEach(t => t.classList.remove("active"));
        allTag.classList.add("active");
        filterReports();
      };
      tagContainer.appendChild(allTag);
      
      types.forEach(type => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = type;
        span.onclick = () => {
          allTag.classList.remove("active");
          span.classList.toggle("active");
          filterReports();
        };
        tagContainer.appendChild(span);
      });
    }

    function clearAllFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("agencyFilter").selectedIndex = 0;
      document.getElementById("topicFilter").selectedIndex = 0;
      document.getElementById("yearFilter").selectedIndex = 0;
      
      // Reset tags - make "All" active, others inactive
      document.querySelectorAll(".tag").forEach((tag, index) => {
        tag.classList.toggle("active", index === 0);
      });
      
      filterReports();
    }

    function exportFilteredCSV() {
      if (filteredReports.length === 0) {
        alert("No reports to export.");
        return;
      }
      
      const headers = ["Title", "Summary", "Agency/Topic", "Date", "Report Type", "PDF URL", "Web URL"];
      const csvContent = [headers.join(",")];
      
      filteredReports.forEach(row => {
        const title = (row.title || "").replace(/"/g, '""');
        const summary = (row.summary || "").replace(/\n/g, " ").replace(/"/g, '""');
        
        const topicOrAgency = row.reportType === "CRS" 
          ? (row.topics && row.topics.join(", ")) || "" 
          : row.agency || "";
          
        const date = row.date || "";
        const type = row.reportType || "";
        const pdf = row.pdf_url || "";
        const web = row.web_url || "";
        
        csvContent.push(`"${title}","${summary}","${topicOrAgency}","${date}","${type}","${pdf}","${web}"`);
      });
      
      const blob = new Blob([csvContent.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.setAttribute("download", "government_reports.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Pagination event handlers
    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
        renderCurrentPage();
        window.scrollTo(0, 0);
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
        renderCurrentPage();
        window.scrollTo(0, 0);
      }
    });

    async function init() {
      try {
        // Show loading state
        document.getElementById("reportList").innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Loading reports data...</p>
          </div>
        `;
        
        const crsRaw = await loadCSVasDataFrame("data/sampled_crs_list.csv", "CRS");
        const finRaw = await loadCSVasDataFrame("data/sampled_financial_reports.csv", "");

        reportData = [
          ...crsRaw.map(row => ({
            title: row.title || "Untitled",
            summary: row.summary || "",
            agency: "",
            topicDisplay: (row.topics || "Misc").split(",")[0].trim(),
            topics: (row.topics || "").split(",").map(s => s.trim()).filter(Boolean),
            date: row.publishDate || "",
            reportType: "CRS",
            pdf_url: row.pdf_url || "",
            web_url: row.web_url || ""
          })),
          ...finRaw.map(row => ({
            title: row["Report Name"] || "Untitled",
            summary: row["Description"] || "",
            agency: row["Agency"] || "Unknown",
            topicDisplay: "",
            topics: [],
            date: row["Year"] || "",
            reportType: row["Report Type"] || "Unknown",
            pdf_url: row["Report PDF Link"] || "",
            web_url: row["Reporting Hosting Web Page"] || ""
          }))
        ];

        // Create unique sets of filter options
        const agencyOptions = extractUnique(finRaw, "Agency");
        const topicOptions = extractUnique(crsRaw, "topics", ",");
        renderMultiselect("agencyFilter", agencyOptions);
        renderMultiselect("topicFilter", topicOptions);

        const years = [...new Set(reportData
          .map(r => r.date && r.date.split("-")[0])
          .filter(Boolean))]
          .sort()
          .reverse(); // Most recent years first
          
        renderMultiselect("yearFilter", years);

        // Render report type tags
        const reportTypes = [...new Set(reportData.map(r => r.reportType).filter(Boolean))];
        renderTags(reportTypes);

        // Setup event listeners
        document.getElementById("searchInput").addEventListener("input", filterReports);
        document.getElementById("agencyFilter").addEventListener("change", filterReports);
        document.getElementById("topicFilter").addEventListener("change", filterReports);
        document.getElementById("yearFilter").addEventListener("change", filterReports);

        // Initial filtering and rendering
        filterReports();
      } catch (error) {
        console.error("Error initializing application:", error);
        document.getElementById("reportList").innerHTML = `
          <div class="error">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h3>Error Loading Data</h3>
            <p>There was a problem loading the report data. Please try refreshing the page.</p>
          </div>
        `;
      }
    }

    // Initialize the application
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
