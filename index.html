<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Government Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png'); background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-position: center; opacity: 0.97;">
  <div class="container">
    <header>
      <h1>Government Reports</h1>
      <button class="chat-button">ðŸ’¬ Chat with AI</button>
    </header>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Search reports...">
      <select id="agencyFilter" multiple></select>
      <select id="topicFilter" multiple></select>
      <select id="yearFilter"></select>
      <button class="clear-button" onclick="clearAllFilters()">Clear All Filters</button>
      <button class="export-button" onclick="exportFilteredCSV()">Download CSV</button>
    </div>

    <div class="tags" id="tagContainer"></div>
    <div id="reportList"></div>
  </div>

  <script>
    async function loadCSVasDataFrame(url, reportType) {
      const res = await fetch(url);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      return parsed.data.map(row => {
        if (reportType) row.reportType = reportType;
        return row;
      });
    }

    function extractUnique(df, key, splitter = null) {
      const all = df.flatMap(row => {
        const value = row[key] || "";
        return splitter ? value.split(splitter).map(v => v.trim()) : [value.trim()];
      });
      return [...new Set(all.filter(Boolean))].sort();
    }

    function renderMultiselect(id, values) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      const anyOption = document.createElement("option");
      anyOption.value = "__any__";
      anyOption.textContent = "Any";
      select.appendChild(anyOption);
      values.forEach(v => {
        const option = document.createElement("option");
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
      });
    }

    let reportData = [];

    function getSelectedValues(select) {
      const selected = [...select.selectedOptions].map(opt => opt.value);
      return selected.includes("__any__") ? [] : selected;
    }

    function renderReports() {
      const searchVal = document.getElementById("searchInput").value.toLowerCase();
      const selectedAgencies = getSelectedValues(document.getElementById("agencyFilter"));
      const selectedTopics = getSelectedValues(document.getElementById("topicFilter"));
      const year = document.getElementById("yearFilter").value;
      const activeTags = [...document.querySelectorAll(".tag.active")].map(t => t.textContent);

      const filtered = reportData.filter(row => {
        const matchesSearch = !searchVal || row.title.toLowerCase().includes(searchVal) || row.summary.toLowerCase().includes(searchVal);
        const matchesType = activeTags.length === 0 || activeTags.includes(row.reportType);
        const matchesAgency = row.reportType !== "CRS" ? (selectedAgencies.length === 0 || selectedAgencies.includes(row.agency)) : true;

        const matchesCRSTopic = row.reportType === "CRS"
          ? (selectedTopics.length === 0 || row.topics.some(t => selectedTopics.includes(t)))
          : true;

        const matchesFinRelevance = row.reportType !== "CRS"
          ? (selectedTopics.length === 0 || selectedTopics.some(topic => {
              const lowerTopic = topic.toLowerCase();
              return row.title.toLowerCase().includes(lowerTopic) || row.agency.toLowerCase().includes(lowerTopic);
            }))
          : true;

        const matchesYear = !year || year === "__any__" || row.date.startsWith(year);

        return matchesSearch && matchesType && matchesAgency && matchesCRSTopic && matchesFinRelevance && matchesYear;
      });

      const container = document.getElementById("reportList");
      container.innerHTML = "";

      filtered.forEach(row => {
        const card = document.createElement("div");
        card.className = "report-card";
        const pdfLink = row.pdf_url ? `<p><a href="${row.pdf_url}" target="_blank">PDF Report</a></p>` : "";
        const webLink = row.web_url ? `<p><a href="${row.web_url}" target="_blank">Web Page</a></p>` : "";
        card.innerHTML = `
          <div class="badge">${row.reportType}</div>
          <h3>${row.title}</h3>
          <p class="summary">${row.summary}</p>
          <p><strong>${row.reportType === "CRS" ? row.topics.join(", ") : row.agency}</strong></p>
          <p>${row.date}</p>
          ${pdfLink}
          ${webLink}
        `;
        const summaryEl = card.querySelector(".summary");
        summaryEl.addEventListener("click", () => summaryEl.classList.toggle("expanded"));
        container.appendChild(card);
      });
    }

    function renderTags(types) {
      const tagContainer = document.getElementById("tagContainer");
      tagContainer.innerHTML = "";
      types.forEach(type => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = type;
        span.onclick = () => {
          span.classList.toggle("active");
          renderReports();
        };
        tagContainer.appendChild(span);
      });
    }

    function clearAllFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("agencyFilter").selectedIndex = 0;
      document.getElementById("topicFilter").selectedIndex = 0;
      document.getElementById("yearFilter").selectedIndex = 0;
      document.querySelectorAll(".tag.active").forEach(tag => tag.classList.remove("active"));
      renderReports();
    }

    function exportFilteredCSV() {
      const rows = document.querySelectorAll(".report-card");
      if (rows.length === 0) {
        alert("No reports to export.");
        return;
      }
      const headers = ["Title", "Summary", "Agency/Topic", "Date", "Report Type", "PDF URL", "Web URL"];
      const csvContent = [headers.join(",")];
      rows.forEach(card => {
        const title = card.querySelector("h3")?.textContent || "";
        const summary = card.querySelector(".summary")?.textContent.replace(/\n/g, " ").replace(/\"/g, "\"\"") || "";
        const label = card.querySelector("strong")?.textContent || "";
        const date = card.querySelector("p:nth-of-type(3)")?.textContent || "";
        const type = card.querySelector(".badge")?.textContent || "";
        const pdf = card.querySelector("a[href*='.pdf']")?.href || "";
        const web = card.querySelector("a[href*='http']:not([href*='.pdf'])")?.href || "";
        csvContent.push(`"${title}","${summary}","${label}","${date}","${type}","${pdf}","${web}"`);
      });
      const blob = new Blob([csvContent.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.setAttribute("download", "filtered_reports.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function init() {
      const crsRaw = await loadCSVasDataFrame("data/sampled_crs_list.csv", "CRS");
      const finRaw = await loadCSVasDataFrame("data/sampled_financial_reports.csv", "");

      reportData = [...crsRaw.map(row => ({
        title: row.title || "Untitled",
        summary: row.summary || "",
        agency: "",
        topicDisplay: (row.topics || "Misc").split(",")[0].trim(),
        topics: (row.topics || "").split(",").map(s => s.trim()).filter(Boolean),
        date: row.publishDate || "",
        reportType: "CRS",
        pdf_url: row.pdf_url || "",
        web_url: row.web_url || ""
      })),
      ...finRaw.map(row => ({
        title: row["Report Name"] || "Untitled",
        summary: "",
        agency: row["Agency"] || "Unknown",
        topicDisplay: "",
        topics: [],
        date: row["Year"] || "",
        reportType: row["Report Type"] || "Unknown",
        pdf_url: row["Report PDF Link"] || "",
        web_url: row["Reporting Hosting Web Page"] || ""
      }))];

      const agencyOptions = extractUnique(finRaw, "Agency");
      const topicOptions = extractUnique(crsRaw, "topics", ",");
      renderMultiselect("agencyFilter", agencyOptions);
      renderMultiselect("topicFilter", topicOptions);

      const years = [...new Set(reportData.map(r => r.date.split("-")[0]).filter(Boolean))].sort();
      renderMultiselect("yearFilter", years);

      renderTags(["CRS", "AFR", "PAR", "CJ"]);

      document.getElementById("searchInput").oninput = renderReports;
      document.getElementById("agencyFilter").onchange = renderReports;
      document.getElementById("topicFilter").onchange = renderReports;
      document.getElementById("yearFilter").onchange = renderReports;

      renderReports();
    }

    init();
  </script>
</body>
</html>
